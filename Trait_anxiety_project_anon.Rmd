---
title: "Trait_anxiety_project"
output: html_document
---

Clear environment (if needed)
```{r}
rm(list = ls())
```

## Load necessary packages
```{r}
library(plyr)
library(lme4)
library(MuMIn)
library(emmeans)
library(ggeffects)
library(ggplot2)
library(ggbeeswarm)
library(sjPlot)
library(sjmisc)
library(sjstats)
library(effsize)
library(gridExtra)
library(pwr)
library(car)
library(RColorBrewer)
library(esc)
library(reghelper)
```

## Load data
```{r}
setwd("C:/Users/Caroline/Box Sync/Post-doc Projects/Anxiety_project")
df <- read.csv("Anxiety_all_data_anon.csv")
df_cl <- df[complete.cases(df[ , 3:4]), ] #version of the data excluding missing gender and age data
df2 <- df[!(df$Site=="Site1" | df$Site=="Site3" | df$Site=="Site4"), ] #excluding study site with data from only 1 condition
df2_cl <- df2[complete.cases(df2[ , 3:4]), ]
```

## Perform some descriptive statistics
```{r}
x <- matrix(c(33, 31, 117, 91), ncol = 2)
csx <- chisq.test(x, correct=FALSE)
csx
esc_chisq(chisq = csx$statistic, totaln = 272, es.type = "d")
```

Counts
```{r}
count(df, c("Gender","Condition"))
count(df, c("Screening","Condition"))
count(df, c("Stressor","Condition"))
count(df, c("Drug","Condition"))
count(df, c("Site","Condition"))
count(df, c("Site","Condition","Gender"))
```

```{r}
csGend <- chisq.test(df$Condition, df$Gender, correct=FALSE)
csPsyc <- chisq.test(df$Condition, df$Screening, correct=FALSE)
csStre <- chisq.test(df$Condition, df$Stressor, correct=FALSE)
csDrug <- chisq.test(df$Condition, df$Drug, correct=FALSE)

csGend
csPsyc
csStre
csDrug
```

```{r}
esc_chisq(chisq = csGend$statistic, totaln = 3589, es.type = "d")
esc_chisq(chisq = csPsyc$statistic, totaln = 3589, es.type = "d")
esc_chisq(chisq = csStre$statistic, totaln = 3589, es.type = "d")
esc_chisq(chisq = csDrug$statistic, totaln = 3589, es.type = "d")
```


Mean trait anxiety by group and site
```{r}
aggregate(Trait.anxiety ~ Condition + Site, data = df, mean)
aggregate(Trait.anxiety ~ Condition + Site, data = df, sd)
```

Mean and SD trait anxiety by site
```{r}
aggregate(Trait.anxiety ~ Site, data = df, mean)
aggregate(Trait.anxiety ~ Site, data = df, sd)
```

Save trait anxiety by group in mu variable
```{r}
mu <- ddply(df, "Condition", summarise, grp.mean=mean(Trait.anxiety))
head(mu)
ddply(df, "Condition", summarise, grp.sd=sd(Trait.anxiety))

```

Age by group
```{r}
ddply(df_cl, "Condition", summarise, grp.mean=mean(Age))
ddply(df_cl, "Condition", summarise, grp.sd=sd(Age))
```

T-test (assuming unequal variance) and effect size
```{r}
t.test(df$Trait.anxiety ~ df$Condition, var.equal = FALSE)
cohen.d(df$Trait.anxiety, df$Condition, pooled=TRUE, paired=FALSE)
```

```{r}
t.test(df_cl$Age ~ df_cl$Condition, var.equal = FALSE)
cohen.d(df_cl$Age, df_cl$Condition, pooled=TRUE, paired=FALSE)
```

## Plot of trait anxiety distribution
```{r, echo=FALSE, fig.height = 3, fig.width = 4.9}
ggplot(df, aes(x=Trait.anxiety)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.8, binwidth = 1, color="black", fill="grey80") +
  geom_density(alpha=0.2) +
  geom_vline(data=df, aes(xintercept=mean(Trait.anxiety)), linetype="solid", size=1.2) +
  labs(x="Trait anxiety", y = "Density") +
  theme_classic()
```
```{r, echo=FALSE}
cat("Mean trait anxiety: ", mean(df$Trait.anxiety))
cat("\nSD trait anxiety: ", sd(df$Trait.anxiety))
```

```{r, echo=FALSE, fig.height = 3, fig.width = 6}
ggplot(df, aes(x=Trait.anxiety, color=Condition, fill=Condition)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.4, binwidth = 1) +
  geom_density(alpha=0.2) +
  geom_vline(data=mu, aes(xintercept=grp.mean, color=Condition), linetype="solid", size=1.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  labs(x="Trait anxiety", y = "Density") +
  theme_classic()
```


## Mixed effect model
```{r}
#control parameters to use in all models
control_params = lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000))
```

```{r}
null_m <- lmer(Trait.anxiety ~ 1 + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
summary(null_m)
```

```{r}
full_fe <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) + Age
             + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
re_full <- ranef(full_fe)$Site #extract random effects
summary(full_fe)
```

Effect sizes
```{r}
EM_cond <- emmeans(full_fe, c("Condition"), pbkrtest.limit = 3486)
EM_gend <- emmeans(full_fe, c("Gender"), pbkrtest.limit = 3486)
EM_scre <- emmeans(full_fe, c("Screening"), pbkrtest.limit = 3486)
EM_stre <- emmeans(full_fe, c("Stressor"), pbkrtest.limit = 3486)
EM_drug <- emmeans(full_fe, c("Drug"), pbkrtest.limit = 3486)

es_cond <- eff_size(EM_cond, sigma = sigma(full_fe), edf = Inf)
es_gend <- eff_size(EM_gend, sigma = sigma(full_fe), edf = Inf)
es_psyc <- eff_size(EM_scre, sigma = sigma(full_fe), edf = Inf)
es_stre <- eff_size(EM_stre, sigma = sigma(full_fe), edf = Inf)
es_drug <- eff_size(EM_drug, sigma = sigma(full_fe), edf = Inf)

summary(es_cond)
summary(es_gend)
summary(es_psyc)
summary(es_stre)
summary(es_drug)
```


```{r}
#full models without one of the fixed effects
fe_cond <- lmer(Trait.anxiety ~ Gender + factor(Screening) + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_gend <- lmer(Trait.anxiety ~ Condition + factor(Screening) + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_psyc <- lmer(Trait.anxiety ~ Condition + Gender + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_stre <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_drug <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_age <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
               + (1 | Site),data = df_cl, REML=FALSE, control = control_params)

#look at significance of fixed effects
anova(fe_cond, full_fe)
anova(fe_gend, full_fe)
anova(fe_psyc, full_fe)
anova(fe_stre, full_fe)
anova(fe_drug, full_fe)
anova(fe_age, full_fe)
```

## Plot marginal means

```{r, echo=FALSE, fig.height = 4, fig.width = 6}
colsdark2 <- brewer.pal(n = 8, name = "Dark2")
TA_EM_cond <- summary(EM_cond)$emmean
TA_EM_scre <- summary(EM_scre)$emmean
TA_EM_stre <- summary(EM_stre)$emmean
TA_EM_drug <- summary(EM_drug)$emmean
TA_EM_gend <- summary(EM_gend)$emmean

emms <- data.frame("Condition" = c("behavior","MRI"), "Trait.anxiety" = TA_EM_cond)
pcond <- ggplot(df_cl, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = colsdark2[1:2]) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(y="Trait anxiety") + guides(fill=FALSE)

emms <- data.frame("Screening" = c(0,1), "Trait.anxiety" = TA_EM_scre)
pscre <- ggplot(df_cl, aes(x=factor(Screening), y=Trait.anxiety, fill=factor(Screening))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = colsdark2[3:4]) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Screening", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Stressor" = c(0,1), "Trait.anxiety" = TA_EM_stre)
pstre <- ggplot(df_cl, aes(x=factor(Stressor), y=Trait.anxiety, fill=factor(Stressor))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Stressor", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Drug" = c(0,1), "Trait.anxiety" = TA_EM_drug)
pdrug <- ggplot(df_cl, aes(x=factor(Drug), y=Trait.anxiety, fill=factor(Drug))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Drug", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Gender" = c("F","M"), "Trait.anxiety" = TA_EM_gend)
pgend <- ggplot(df_cl, aes(x=Gender, y=Trait.anxiety, fill=Gender)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(y="Trait anxiety") + guides(fill=FALSE)

#trait anxiety by age
test <- ggpredict(full_fe, terms = "Age")
p_age <- ggplot() + geom_point(data=df_cl, aes(x=Age, y=Trait.anxiety), shape=16, alpha=0.2, color="indianred") + 
    geom_line(data=test, aes(x, predicted), color="darkblue", size=1.2) +
    geom_ribbon(data=test, aes(x, ymin=conf.low, ymax=conf.high), fill="darkblue", alpha=0.2) +
    geom_text(aes(x=60, y=60, label=paste("beta==", round(coef(summary(full_fe))["Age", "Estimate"], digits=3))),
              size=3, color="darkblue", parse = TRUE) +
    theme_classic() + labs(y="Trait anxiety")


grid.arrange(pcond, pscre, p_age, pstre, pdrug, pgend, nrow=2)
```


Test that effect of age on trait anxiety is not driven exclusively by "older" subjects
```{r, fig.height = 3, fig.width = 3}
df_y <- df_cl[df_cl$Age<=35, ] #excluding subjects older than 35
cor.test(df_y$Age, df_y$Trait.anxiety, method="pearson")
ggplot(df_y, aes(x=Age, y=Trait.anxiety)) + geom_point(shape=16, alpha=0.2) +  
  geom_smooth(method=lm, colour="red", fill="red") + theme_classic()
aggregate(Trait.anxiety ~ Age, data = df_y, mean)
```

## Mixed effect model with random effect of condition
```{r}
full_re <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)
re_full2 <- ranef(full_re)$Site #extract random effects
summary(full_re)
```

## Mixed effect model with interactions
```{r}
full_int <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Screening) + Condition:factor(Stressor) + Condition:factor(Drug)
                + Condition:Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)
re_int <- ranef(full_int)$Site #extract random effects
summary(full_int)
```



```{r}
#full interaction model without one of random effect
int_nore <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Screening) + Condition:factor(Stressor) + Condition:factor(Drug)
                + Condition:Age + (1 | Site), data = df2, REML=FALSE, control = control_params)

#look at significance of the random effect
anova(full_int, int_nore)
```

```{r}
#full interaction model without one of the interactions
int_cgend <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:factor(Screening) + Condition:factor(Stressor) + Condition:factor(Drug)
                + Condition:Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)

int_cpsyc <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Stressor) + Condition:factor(Drug)
                + Condition:Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)

int_cstre <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Screening) + Condition:factor(Drug)
                + Condition:Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)

int_cdrug <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Screening) + Condition:factor(Stressor)
                + Condition:Age + (Condition | Site), data = df2, REML=FALSE, control = control_params)

int_cage <- lmer(Trait.anxiety ~ Condition + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Condition:Gender + Condition:factor(Screening) + Condition:factor(Stressor) + Condition:factor(Drug)
                + (Condition | Site), data = df2, REML=FALSE, control = control_params)

#look at significance of fixed effects
anova(full_int, int_cgend)
anova(full_int, int_cpsyc)
anova(full_int, int_cstre)
anova(full_int, int_cdrug)
anova(full_int, int_cage)
```


Effect sizes of interactions
```{r}
emm_cond_gend <- emmeans(full_int, c("Condition","Gender"), pbkrtest.limit = 3277)
emm_cond_psyc <- emmeans(full_int, c("Condition","Screening"), pbkrtest.limit = 3277)
emm_cond_stre <- emmeans(full_int, c("Condition","Stressor"), pbkrtest.limit = 3277)
emm_cond_drug <- emmeans(full_int, c("Condition","Drug"), pbkrtest.limit = 3277)

es_cond_gend <- eff_size(emm_cond_gend, sigma = sigma(full_int), edf = Inf)
es_cond_psyc <- eff_size(emm_cond_psyc, sigma = sigma(full_int), edf = Inf)
es_cond_stre <- eff_size(emm_cond_stre, sigma = sigma(full_int), edf = Inf)
es_cond_drug <- eff_size(emm_cond_drug, sigma = sigma(full_int), edf = Inf)

summary(es_cond_gend)
summary(es_cond_psyc)
summary(es_cond_stre)
summary(es_cond_drug)
```

Effect sizes of main effects in interaction model
```{r}
emm_cond <- emmeans(full_int, "Condition", pbkrtest.limit = 3277)
emm_gend <- emmeans(full_int, "Gender", pbkrtest.limit = 3277)
emm_psyc <- emmeans(full_int, "Screening", pbkrtest.limit = 3277)
emm_stre <- emmeans(full_int, "Stressor", pbkrtest.limit = 3277)
emm_drug <- emmeans(full_int, "Drug", pbkrtest.limit = 3277)

summary(eff_size(emm_cond, sigma = sigma(full_int), edf = Inf))
summary(eff_size(emm_gend, sigma = sigma(full_int), edf = Inf))
summary(eff_size(emm_psyc, sigma = sigma(full_int), edf = Inf))
summary(eff_size(emm_stre, sigma = sigma(full_int), edf = Inf))
summary(eff_size(emm_drug, sigma = sigma(full_int), edf = Inf))
```


## Plot trait anxiety by group for each university
```{r, echo=FALSE, fig.height = 2, fig.width = 12}
muu <- ddply(df2, c("Condition","Site"), summarise, grp.mean=mean(Trait.anxiety))
ggplot(df2, aes(x=Trait.anxiety, color=Condition, fill=Condition)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.3, binwidth = 2) +
  geom_density(alpha=0.2) +
  geom_vline(data=muu, aes(xintercept=grp.mean, color=Condition), linetype="solid", size=1.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  theme_classic() + facet_wrap(~ Site, nrow=1)
```

```{r, echo=FALSE, fig.height = 3, fig.width = 10}
muu <- ddply(df2, c("Condition","Site"), summarise, grp.mean=mean(Trait.anxiety))
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  stat_summary(fun.y=mean, color="darkred", geom="point", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = muu, aes(label = round(grp.mean,2), y = 20), size=3, show.legend=FALSE, color="darkred", alpha=1) +
  theme_classic() + facet_wrap(~ Site, nrow=1)
```


## Trait anxiety by group & Screening

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
muu <- ddply(df2, c("Condition","Screening"), summarise, grp.mean=mean(Trait.anxiety))
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  stat_summary(fun.y=mean, color="darkred", geom="point", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = muu, aes(label = round(grp.mean,2), y = 20), size=3, show.legend=FALSE, color="darkred", alpha=1) +
  theme_classic() + facet_wrap(~ Screening, nrow=1, labeller = as_labeller(c("0"="No Screening", "1"="Screening"))) + labs(y="Trait anxiety")
```

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
TA_EM_psyc <- summary(emm_cond_psyc)$emmean
emms <- data.frame("Condition" = c("behavior","MRI","behavior","MRI"), "Screening" = c(0,0,1,1), "Trait.anxiety" = TA_EM_psyc)
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Screening, nrow=1, labeller = as_labeller(c("0"="No Screening", "1"="Screening"))) + labs(y="Trait anxiety")
```


## Trait anxiety by group & Stressor

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
muu <- ddply(df2, c("Condition","Stressor"), summarise, grp.mean=mean(Trait.anxiety))
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  stat_summary(fun.y=mean, color="darkred", geom="point", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = muu, aes(label = round(grp.mean,2), y = 20), size=3, show.legend=FALSE, color="darkred", alpha=1) +
  theme_classic() + facet_wrap(~ Stressor, nrow=1, labeller = as_labeller(c("0"="No Stressor", "1"="Stressor"))) + labs(y="Trait anxiety")
```
```{r, echo=FALSE, fig.height = 3, fig.width = 4}
TA_EM_stre <- summary(emm_cond_stre)$emmean
emms <- data.frame("Condition" = c("behavior","MRI","behavior","MRI"), "Stressor" = c(0,0,1,1), "Trait.anxiety" = TA_EM_stre)
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Stressor, nrow=1, labeller = as_labeller(c("0"="No Stressor", "1"="Stressor"))) + labs(y="Trait anxiety")
```

## Trait anxiety by group & Drug

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
muu <- ddply(df2, c("Condition","Drug"), summarise, grp.mean=mean(Trait.anxiety))
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  stat_summary(fun.y=mean, color="darkred", geom="point", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = muu, aes(label = round(grp.mean,2), y = 20), size=3, show.legend=FALSE, color="darkred", alpha=1) +
  theme_classic() + facet_wrap(~ Drug, nrow=1, labeller = as_labeller(c("0"="No Drug", "1"="Drug"))) + labs(y="Trait anxiety")
```

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
TA_EM_drug <- summary(emm_cond_drug)$emmean
emms <- data.frame("Condition" = c("behavior","MRI","behavior","MRI"), "Drug" = c(0,0,1,1), "Trait.anxiety" = TA_EM_drug)
ggplot(df2, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Drug, nrow=1, labeller = as_labeller(c("0"="No Drug", "1"="Drug"))) + labs(y="Trait anxiety")
```

## Trait anxiety by group & Gender

```{r, echo=FALSE, fig.height = 3, fig.width = 4}
muu <- ddply(df2, c("Condition","Gender"), summarise, grp.mean=mean(Trait.anxiety))
TA_EM_gend <- summary(emm_cond_gend)$emmean
emms <- data.frame("Condition" = c("behavior","MRI","behavior","MRI"), "Gender" = c("F","F","M","M"), "Trait.anxiety" = TA_EM_gend)
ggplot(df2_cl, aes(x=Condition, y=Trait.anxiety, fill=Condition)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Gender, nrow=1, labeller = as_labeller(c("F"="Female", "M"="Male"))) + labs(y="Trait anxiety")
```

## Trait anxiety by Condition & Age
```{r}
emm_cond_age <- emtrends(full_int, pairwise ~ Condition, var="Age", pbkrtest.limit = 3277)
```

```{r}
test0 <- emm_cond_age$emtrends
test0
eff_size(test0, sigma = sigma(full_fe), edf = Inf)

```

```{r, echo=FALSE, fig.height = 3, fig.width = 5}
test2 <- ggpredict(full_int, terms = c("Age","Condition"))
colnames(test2)[6] <- "Condition"
ggplot() + geom_point(data=df2_cl, aes(x=Age, y=Trait.anxiety, color=Condition), shape=16, alpha=0.2) + 
    geom_line(data=test2, aes(x, predicted, color=Condition), size=1.2) +
    geom_ribbon(data=test2, aes(x, ymin=conf.low, ymax=conf.high, fill=Condition), alpha=0.2) +
    geom_text(aes(x=67, y=26, label=paste("beta==", "-0.157")), size=3.5, color=colsdark2[1], parse = TRUE) +
    geom_text(aes(x=67, y=43, label=paste("beta==", "-0.015")), size=3.5, color=colsdark2[2], parse = TRUE) +
    theme_classic() + labs(y="Trait anxiety") + 
    scale_fill_brewer(palette="Dark2") + scale_color_brewer(palette="Dark2")
```



