---
title: "Trait_anxiety_project"
output: html_document
---

Clear environment (if needed)
```{r}
rm(list = ls())
```

## Load necessary packages
```{r}
library(esc)
library(plyr)
library(lme4)
library(effsize)
library(ggplot2)
library(emmeans)
library(pbkrtest)
library(RColorBrewer)
library(ggeffects)
library(gridExtra)
```

## Load data
```{r}
setwd("C:/Users/Caroline/Box Sync/Post-doc Projects/Anxiety_project")
df_all <- read.csv("Anxiety_all_data_anon.csv")
df <- df_all[!(df_all$Preliminary_data==1), ]
df_cl <- df[complete.cases(df[ , 3:4]), ] #version of the data excluding missing gender and age data
df2 <- df[!(df$Site=="Site2" | df$Site=="Site4"), ] #excluding study site with data from only 1 condition
df2_cl <- df2[complete.cases(df2[ , 3:4]), ]
```

## Perform some descriptive statistics
Counts
```{r}
count(df, c("Gender","Context"))
count(df, c("Screening","Context"))
count(df, c("Stressor","Context"))
count(df, c("Drug","Context"))
count(df, c("Site","Context"))
count(df, c("Site","Context","Gender"))
```

```{r}
csGend <- chisq.test(df$Context, df$Gender, correct=FALSE)
csPsyc <- chisq.test(df$Context, df$Screening, correct=FALSE)
csStre <- chisq.test(df$Context, df$Stressor, correct=FALSE)
csDrug <- chisq.test(df$Context, df$Drug, correct=FALSE)

csGend
csPsyc
csStre
csDrug
```

```{r}
esc_chisq(chisq = csGend$statistic, totaln = 3317, es.type = "d")
esc_chisq(chisq = csPsyc$statistic, totaln = 3317, es.type = "d")
esc_chisq(chisq = csStre$statistic, totaln = 3317, es.type = "d")
esc_chisq(chisq = csDrug$statistic, totaln = 3317, es.type = "d")
```


Mean trait anxiety by group and site
```{r}
aggregate(Trait.anxiety ~ Context + Site, data = df, mean)
aggregate(Trait.anxiety ~ Context + Site, data = df, sd)
```

Mean and SD trait anxiety by site
```{r}
aggregate(Trait.anxiety ~ Site, data = df, mean)
aggregate(Trait.anxiety ~ Site, data = df, sd)
```

Save trait anxiety by group in mu variable
```{r}
mu <- ddply(df, "Context", summarise, grp.mean=mean(Trait.anxiety))
head(mu)
ddply(df, "Context", summarise, grp.sd=sd(Trait.anxiety))
```

Age by study context
```{r}
ddply(df_cl, "Context", summarise, grp.mean=mean(Age))
ddply(df_cl, "Context", summarise, grp.sd=sd(Age))
```

Counts and aggregate broken down by every categorical variable
```{r}
count(df, c("Context","Gender","Screening","Stressor","Drug"))
aggregate(Trait.anxiety ~ factor(Drug) + factor(Stressor) + factor(Screening) + Gender + Context, data = df, mean)
aggregate(Trait.anxiety ~ factor(Drug) + factor(Stressor) + factor(Screening) + Gender + Context, data = df, sd)
```

## T-test (assuming unequal variance) and effect size
Effect of study context
```{r}
t.test(df$Trait.anxiety ~ df$Context, var.equal = FALSE)
cohen.d(df$Trait.anxiety, df$Context, pooled=TRUE, paired=FALSE)
```

Effect of gender on trait anxiety
```{r}
t.test(df$Trait.anxiety ~ df$Gender, var.equal = FALSE)
cohen.d(df$Trait.anxiety, df$Gender, pooled=TRUE, paired=FALSE)
```

Effect of screening on trait anxiety
```{r}
t.test(df$Trait.anxiety ~ df$Screening, var.equal = FALSE)
cohen.d(df$Trait.anxiety, df$Screening, pooled=TRUE, paired=FALSE)
```


Effect of context on age
```{r}
t.test(df_cl$Age ~ df_cl$Context, var.equal = FALSE)
cohen.d(df_cl$Age, df_cl$Context, pooled=TRUE, paired=FALSE)
```

Effect of context per site
```{r}
t.test(df[df$Site=="Site1", ]$Trait.anxiety ~ df[df$Site=="Site1", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site1", ]$Trait.anxiety, df[df$Site=="Site1", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site3", ]$Trait.anxiety ~ df[df$Site=="Site3", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site3", ]$Trait.anxiety, df[df$Site=="Site3", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site5", ]$Trait.anxiety ~ df[df$Site=="Site5", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site5", ]$Trait.anxiety, df[df$Site=="Site5", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site6", ]$Trait.anxiety ~ df[df$Site=="Site6", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site6", ]$Trait.anxiety, df[df$Site=="Site6", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site7", ]$Trait.anxiety ~ df[df$Site=="Site7", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site7", ]$Trait.anxiety, df[df$Site=="Site7", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site8", ]$Trait.anxiety ~ df[df$Site=="Site8", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site8", ]$Trait.anxiety, df[df$Site=="Site8", ]$Context, pooled=TRUE, paired=FALSE)

t.test(df[df$Site=="Site9", ]$Trait.anxiety ~ df[df$Site=="Site9", ]$Context, var.equal = FALSE)
cohen.d(df[df$Site=="Site9", ]$Trait.anxiety, df[df$Site=="Site9", ]$Context, pooled=TRUE, paired=FALSE)
```



## Plot of trait anxiety distribution

Function to estimate mode
```{r}
estimate_mode <- function(x) {
  d <- density(x)
  d$x[which.max(d$y)]
}
```

Mean, SD, Mode of trait anxiety across the whole sample
```{r}
cat("Mean trait anxiety: ", mean(df$Trait.anxiety))
cat("\nSD trait anxiety: ", sd(df$Trait.anxiety))
cat("\nMode trait anxiety: ", estimate_mode(df$Trait.anxiety))
cat("\n80th percentile: ", quantile(df$Trait.anxiety, probs = 0.80))
```

Plot trait anxiety distribution with mode & 80th percentile
```{r, fig.height = 3, fig.width = 4.9}
ggplot(df, aes(x=Trait.anxiety)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.8, binwidth = 1, color="black", fill="grey80") +
  geom_density(alpha=0.2) +
  geom_vline(data=df, aes(xintercept=estimate_mode(Trait.anxiety)), linetype="solid", size=1.2) +
  geom_vline(data=df, aes(xintercept=quantile(Trait.anxiety, probs = 0.80)), linetype="dashed", size=1.2) +
  labs(x="Trait anxiety", y = "Density") +
  theme_classic()
```

Estimate mode & 80th percentile per study context
```{r}
mu_mode <- ddply(df, "Context", summarise, grp.mode=estimate_mode(Trait.anxiety))
mu_qtile <- ddply(df, "Context", summarise, grp.qtile=quantile(Trait.anxiety, probs = 0.80))
```

Plot trait anxiety distribution with mode & 80th percentile per study context
```{r, fig.height = 3, fig.width = 6}
ggplot(df, aes(x=Trait.anxiety, color=Context, fill=Context)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.4, binwidth = 1) +
  geom_density(alpha=0.2) +
  geom_vline(data=mu_mode, aes(xintercept=grp.mode, color=Context), linetype="solid", size=1.2) +
  geom_vline(data=mu_qtile, aes(xintercept=grp.qtile, color=Context), linetype="dashed", size=1.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  labs(x="Trait anxiety", y="Density", color="Study context", fill="Study context") +
  theme_classic()
```


## Mixed effect model
```{r}
#control parameters to use in all models
control_params = lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=100000))
```

```{r}
null_m <- lmer(Trait.anxiety ~ 1 + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
summary(null_m)
```


```{r}
full_fe <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) + Age
             + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
re_full <- ranef(full_fe)$Site #extract random effects
summary(full_fe)
```

Effect sizes
```{r}
EM_cond <- emmeans(full_fe, c("Context"), pbkrtest.limit = 3214)
EM_gend <- emmeans(full_fe, c("Gender"), pbkrtest.limit = 3214)
EM_scre <- emmeans(full_fe, c("Screening"), pbkrtest.limit = 3214)
EM_stre <- emmeans(full_fe, c("Stressor"), pbkrtest.limit = 3214)
EM_drug <- emmeans(full_fe, c("Drug"), pbkrtest.limit = 3214)

es_cond <- eff_size(EM_cond, sigma = sigma(full_fe), edf = 3214)
es_gend <- eff_size(EM_gend, sigma = sigma(full_fe), edf = 3214)
es_psyc <- eff_size(EM_scre, sigma = sigma(full_fe), edf = 3214)
es_stre <- eff_size(EM_stre, sigma = sigma(full_fe), edf = 3214)
es_drug <- eff_size(EM_drug, sigma = sigma(full_fe), edf = 3214)

summary(es_cond)
summary(es_gend)
summary(es_psyc)
summary(es_stre)
summary(es_drug)
```


```{r}
#full models without one of the fixed effects
fe_cond <- lmer(Trait.anxiety ~ Gender + factor(Screening) + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_gend <- lmer(Trait.anxiety ~ Context + factor(Screening) + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_psyc <- lmer(Trait.anxiety ~ Context + Gender + factor(Stressor) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_stre <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Drug) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_drug <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + Age 
                + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
fe_age <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
               + (1 | Site),data = df_cl, REML=FALSE, control = control_params)

#look at significance of fixed effects
anova(fe_cond, full_fe)
anova(fe_gend, full_fe)
anova(fe_psyc, full_fe)
anova(fe_stre, full_fe)
anova(fe_drug, full_fe)
anova(fe_age, full_fe)
```

## Plot marginal means

```{r, fig.height = 4, fig.width = 6}
colsdark2 <- brewer.pal(n = 8, name = "Dark2")
TA_EM_cond <- summary(EM_cond)$emmean
TA_EM_scre <- summary(EM_scre)$emmean
TA_EM_stre <- summary(EM_stre)$emmean
TA_EM_drug <- summary(EM_drug)$emmean
TA_EM_gend <- summary(EM_gend)$emmean

emms <- data.frame("Context" = c("behaviour","MRI"), "Trait.anxiety" = TA_EM_cond)
pcond <- ggplot(df_cl, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = colsdark2[1:2]) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Study context", y="Trait anxiety") + guides(fill=FALSE)

emms <- data.frame("Screening" = c(0,1), "Trait.anxiety" = TA_EM_scre)
pscre <- ggplot(df_cl, aes(x=factor(Screening), y=Trait.anxiety, fill=factor(Screening))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Screening", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Stressor" = c(0,1), "Trait.anxiety" = TA_EM_stre)
pstre <- ggplot(df_cl, aes(x=factor(Stressor), y=Trait.anxiety, fill=factor(Stressor))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Stressor", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Drug" = c(0,1), "Trait.anxiety" = TA_EM_drug)
pdrug <- ggplot(df_cl, aes(x=factor(Drug), y=Trait.anxiety, fill=factor(Drug))) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(x="Drug", y="Trait anxiety") + guides(fill=FALSE) +
  scale_x_discrete(labels=c("0" = "No", "1" = "Yes"))

emms <- data.frame("Gender" = c("F","M"), "Trait.anxiety" = TA_EM_gend)
pgend <- ggplot(df_cl, aes(x=Gender, y=Trait.anxiety, fill=Gender)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + labs(y="Trait anxiety") + guides(fill=FALSE)

#trait anxiety by age
test <- ggpredict(full_fe, terms = "Age")
p_age <- ggplot() + geom_point(data=df_cl, aes(x=Age, y=Trait.anxiety), shape=16, alpha=0.2, color="indianred") + 
    geom_line(data=test, aes(x, predicted), color="darkblue", size=1.2) +
    geom_ribbon(data=test, aes(x, ymin=conf.low, ymax=conf.high), fill="darkblue", alpha=0.2) +
    geom_text(aes(x=60, y=60, label=paste("beta==", round(coef(summary(full_fe))["Age", "Estimate"], digits=3))),
              size=3, color="darkblue", parse = TRUE) +
    theme_classic() + labs(y="Trait anxiety")


grid.arrange(pcond, p_age, pgend, pscre, pstre, pdrug, nrow=2)
```


Test that effect of age on trait anxiety is not driven exclusively by "older" subjects
```{r, fig.height = 3, fig.width = 3}
df_y <- df_cl[df_cl$Age<=35, ] #excluding subjects older than 35
cor.test(df_y$Age, df_y$Trait.anxiety, method="pearson")
ggplot(df_y, aes(x=Age, y=Trait.anxiety)) + geom_point(shape=16, alpha=0.2) +  
  geom_smooth(method=lm, colour="red", fill="red") + theme_classic()
aggregate(Trait.anxiety ~ Age, data = df_y, mean)
```

## Mixed effect model with random effect of study context
```{r}
full_re <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + (Context | Site), data = df2, REML=FALSE, control = control_params)
re_full2 <- ranef(full_re)$Site #extract random effects
summary(full_re)
```

## Mixed effect model with interactions
```{r}
full_int <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Screening) + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2, REML=FALSE, control = control_params)
re_int <- ranef(full_int)$Site #extract random effects
summary(full_int)
```


```{r}
#full interaction model without one of random effect
int_nore <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Screening) + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (1 | Site), data = df2, REML=FALSE, control = control_params)

#look at significance of the random effect
anova(full_int, int_nore)
```

```{r}
#full interaction model without one of the interactions
int_cgend <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:factor(Screening) + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2, REML=FALSE, control = control_params)

int_cpsyc <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2, REML=FALSE, control = control_params)

int_cstre <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Screening) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2, REML=FALSE, control = control_params)

int_cdrug <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Screening) + Context:factor(Stressor)
                + Context:Age + (Context | Site), data = df2, REML=FALSE, control = control_params)

int_cage <- lmer(Trait.anxiety ~ Context + Gender + factor(Screening) + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Screening) + Context:factor(Stressor) + Context:factor(Drug)
                + (Context | Site), data = df2, REML=FALSE, control = control_params)

#look at significance of fixed effects
anova(full_int, int_cgend)
anova(full_int, int_cpsyc)
anova(full_int, int_cstre)
anova(full_int, int_cdrug)
anova(full_int, int_cage)
```


Effect sizes of interactions
```{r}
emm_cond_gend <- emmeans(full_int, c("Context","Gender"), pbkrtest.limit = 3041)
emm_cond_psyc <- emmeans(full_int, c("Context","Screening"), pbkrtest.limit = 3041)
emm_cond_stre <- emmeans(full_int, c("Context","Stressor"), pbkrtest.limit = 3041)
emm_cond_drug <- emmeans(full_int, c("Context","Drug"), pbkrtest.limit = 3041)

es_cond_gend <- eff_size(emm_cond_gend, sigma = sigma(full_int), edf = 3041)
es_cond_psyc <- eff_size(emm_cond_psyc, sigma = sigma(full_int), edf = 3041)
es_cond_stre <- eff_size(emm_cond_stre, sigma = sigma(full_int), edf = 3041)
es_cond_drug <- eff_size(emm_cond_drug, sigma = sigma(full_int), edf = 3041)

summary(es_cond_gend)
summary(es_cond_psyc)
summary(es_cond_stre)
summary(es_cond_drug)
```


## Plot trait anxiety by group for each university
```{r, fig.height = 2, fig.width = 12}
muu <- ddply(df2, c("Context","Site"), summarise, grp.mean=mean(Trait.anxiety))
muu_mode <- ddply(df2, c("Context","Site"), summarise, grp.mode=estimate_mode(Trait.anxiety))
muu_qtile <- ddply(df2, c("Context","Site"), summarise, grp.qtile=quantile(Trait.anxiety, probs = 0.80))
ggplot(df2, aes(x=Trait.anxiety, color=Context, fill=Context)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.3, binwidth = 2) +
  geom_density(alpha=0.2) +
  geom_vline(data=muu_mode, aes(xintercept=grp.mode, color=Context), linetype="solid", size=1.2) +
  geom_vline(data=muu_qtile, aes(xintercept=grp.qtile, color=Context), linetype="dashed", size=1.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  theme_classic() + facet_wrap(~ Site, nrow=1)
```

```{r, fig.height = 3, fig.width = 10}
ggplot(df2, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  stat_summary(fun.y=mean, color="darkred", geom="point", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = muu, aes(label = round(grp.mean,2), y = 20), size=3, show.legend=FALSE, color="darkred", alpha=1) +
  theme_classic() + facet_wrap(~ Site, nrow=1)
```


## Trait anxiety by group & Screening
```{r, fig.height = 3, fig.width = 4}
TA_EM_psyc <- summary(emm_cond_psyc)$emmean
emms <- data.frame("Context" = c("behaviour","MRI","behaviour","MRI"), "Screening" = c(0,0,1,1), "Trait.anxiety" = TA_EM_psyc)
ggplot(df2, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Screening, nrow=1, labeller = as_labeller(c("0"="No Screening", "1"="Screening"))) + 
  labs(x="Study context", y="Trait anxiety", fill="Study context")
```


## Trait anxiety by group & Stressor
```{r, fig.height = 3, fig.width = 4}
TA_EM_stre <- summary(emm_cond_stre)$emmean
emms <- data.frame("Context" = c("behaviour","MRI","behaviour","MRI"), "Stressor" = c(0,0,1,1), "Trait.anxiety" = TA_EM_stre)
ggplot(df2, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Stressor, nrow=1, labeller = as_labeller(c("0"="No Stressor", "1"="Stressor"))) + 
  labs(x="Study context", y="Trait anxiety", fill="Study context")
```

## Trait anxiety by group & Drug
```{r, fig.height = 3, fig.width = 4}
TA_EM_drug <- summary(emm_cond_drug)$emmean
emms <- data.frame("Context" = c("behaviour","MRI","behaviour","MRI"), "Drug" = c(0,0,1,1), "Trait.anxiety" = TA_EM_drug)
ggplot(df2, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Drug, nrow=1, labeller = as_labeller(c("0"="No Drug", "1"="Drug"))) + 
  labs(x="Study context", y="Trait anxiety", fill="Study context")
```

## Trait anxiety by group & Gender
```{r, fig.height = 3, fig.width = 4}
TA_EM_gend <- summary(emm_cond_gend)$emmean
emms <- data.frame("Context" = c("behaviour","MRI","behaviour","MRI"), "Gender" = c("F","F","M","M"), "Trait.anxiety" = TA_EM_gend)
ggplot(df2_cl, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_manual(values = c("grey20","grey80")) +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ Gender, nrow=1, labeller = as_labeller(c("F"="Female", "M"="Male"))) + 
  labs(x="Study context", y="Trait anxiety", fill="Study context")
```

## Trait anxiety by Condition & Age
```{r}
emm_cond_age <- emtrends(full_int, pairwise ~ Context, var="Age", pbkrtest.limit = 3041)
```

```{r}
test0 <- emm_cond_age$emtrends
test0
eff_size(test0, sigma = sigma(full_fe), edf = Inf)
```

```{r, fig.height = 3, fig.width = 5}
test2 <- ggpredict(full_int, terms = c("Age","Context"))
colnames(test2)[6] <- "Context"
ggplot() + geom_point(data=df2_cl, aes(x=Age, y=Trait.anxiety, color=Context), shape=16, alpha=0.2) + 
    geom_line(data=test2, aes(x, predicted, color=Context), size=1.2) +
    geom_ribbon(data=test2, aes(x, ymin=conf.low, ymax=conf.high, fill=Context), alpha=0.2) +
    geom_text(aes(x=67, y=23, label=paste("beta==", "-0.168")), size=3.5, color=colsdark2[1], parse = TRUE) +
    geom_text(aes(x=67, y=46, label=paste("beta==", "-0.003")), size=3.5, color=colsdark2[2], parse = TRUE) +
    theme_classic() + labs(y="Trait anxiety", fill="Study context", color="Study context") + 
    scale_fill_brewer(palette="Dark2") + scale_color_brewer(palette="Dark2")
```

## Follow up analyses with screening type
```{r}
count(df, c("Context","Screening_type"))
chisq.test(df$Context, df$Screening_type, correct=FALSE)
aggregate(Trait.anxiety ~ Context + Screening_type, data = df, mean)
aggregate(Trait.anxiety ~ Context + Screening_type, data = df, sd)
```

```{r}
t.test(df[df$Screening_type == "none", ]$Trait.anxiety ~ df[df$Screening_type == "none", ]$Context, var.equal = FALSE)
cohen.d(df[df$Screening_type == "none", ]$Trait.anxiety ~ df[df$Screening_type == "none", ]$Context, pooled=TRUE, paired=FALSE)
t.test(df[df$Screening_type == "phone", ]$Trait.anxiety ~ df[df$Screening_type == "phone", ]$Context, var.equal = FALSE)
cohen.d(df[df$Screening_type == "phone", ]$Trait.anxiety ~ df[df$Screening_type == "phone", ]$Context, pooled=TRUE, paired=FALSE)
t.test(df[df$Screening_type == "full", ]$Trait.anxiety ~ df[df$Screening_type == "full", ]$Context, var.equal = FALSE)
cohen.d(df[df$Screening_type == "full", ]$Trait.anxiety ~ df[df$Screening_type == "full", ]$Context, pooled=TRUE, paired=FALSE)
```

```{r}
full_fe2 <- lmer(Trait.anxiety ~ Context + Gender + Screening_type + factor(Stressor) + factor(Drug) + Age + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
summary(full_fe2)
```

```{r}
full_nocon2 <- lmer(Trait.anxiety ~ Gender + Screening_type + factor(Stressor) + factor(Drug) + Age + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
full_noscre2 <- lmer(Trait.anxiety ~ Context + Gender + factor(Stressor) + factor(Drug) + Age + (1 | Site), data = df_cl, REML=FALSE, control = control_params)
anova(full_fe2,full_nocon2)
anova(full_fe2,full_noscre2)
```


Effect sizes
```{r}
EM_cond2 <- emmeans(full_fe2, c("Context"), pbkrtest.limit = 3214)
es_cond2 <- eff_size(EM_cond2, sigma = sigma(full_fe2), edf = 3214)
summary(EM_cond2)
summary(es_cond2)
```
```{r}
EM_scre2 <- emmeans(full_fe2, c("Screening_type"), pbkrtest.limit = 3214)
es_scre2 <- eff_size(EM_scre2, sigma = sigma(full_fe2), edf = 3214)
summary(EM_scre2)
summary(es_scre2)
```


Mixed effect model with interactions
```{r}
full_int2 <- lmer(Trait.anxiety ~ Context + Gender + Screening_type + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:Screening_type + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2_cl, REML=FALSE, control = control_params)
summary(full_int2)
```
```{r}
#full interaction model without one of the interactions
int_cpsyc2 <- lmer(Trait.anxiety ~ Context + Gender + Screening_type + factor(Stressor) + factor(Drug) 
                + Age + Context:Gender + Context:factor(Stressor) + Context:factor(Drug)
                + Context:Age + (Context | Site), data = df2_cl, REML=FALSE, control = control_params)

#look at significance of fixed effects
anova(full_int2, int_cpsyc2)
```

Effect sizes of interactions
```{r}
emm_cond_psyc2 <- emmeans(full_int2, c("Context","Screening_type"), pbkrtest.limit = 3041)
es_cond_psyc2 <- eff_size(emm_cond_psyc2, sigma = sigma(full_int2), edf = 3041)
summary(es_cond_psyc2)
```


```{r}
df2_cl$facet = factor(df2_cl$Screening_type, levels = c("none","phone","full"))
df$facet = factor(df$Screening_type, levels = c("none","phone","full"))
```

Plots
```{r, fig.height = 3, fig.width = 5}
TA_EM_psyc2 <- summary(emm_cond_psyc2)$emmean
emms <- data.frame("Context" = c("behaviour","MRI","behaviour","MRI","behaviour","MRI"), "facet" = c("none","none","phone","phone","full","full"), "Trait.anxiety" = TA_EM_psyc2[c(3,4,5,6,1,2)])

ggplot(df2_cl, aes(x=Context, y=Trait.anxiety, fill=Context)) +
  geom_boxplot(notch=TRUE, alpha=0.6, colour="black", lwd=0.7) +
  scale_fill_brewer(palette="Dark2") +
  geom_point(data = emms, color="darkblue", shape=16, size=2, show.legend = FALSE, alpha=1) + 
  geom_text(data = emms, aes(label = round(Trait.anxiety,2), y = 20), size=3, show.legend=FALSE, color="darkblue", alpha=1) +
  theme_classic() + facet_wrap(~ facet, nrow=1) + 
  labs(x="Study context", y="", fill="Study context")
```


```{r}
count(df, c("Context","Screening_type","Site"))
aggregate(Trait.anxiety ~ Context + Screening_type + Site, data = df, mean)
aggregate(Trait.anxiety ~ Context + Screening_type + Site, data = df, sd)
```

```{r, fig.height = 6, fig.width = 8}
# New facet label names
st.labs <- c("No screening", "Phone screening", "Full screening")
names(st.labs) <- c("none", "phone", "full")

muu_mode <- ddply(df, c("facet"), summarise, grp.mode=estimate_mode(Trait.anxiety))
muu_qtile <- ddply(df, c("facet"), summarise, grp.qtile=quantile(Trait.anxiety, probs = 0.80))
p1 <- ggplot(df, aes(x=Trait.anxiety)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.8, binwidth=2, color="black", fill="grey80") +
  geom_density(alpha=0.2) +
  geom_vline(data=muu_mode, aes(xintercept=grp.mode), linetype="solid", size=1.2) +
  geom_vline(data=muu_qtile, aes(xintercept=grp.qtile), linetype="dashed", size=1.2) +
  theme_classic() + facet_wrap(~ facet, ncol=1, labeller = labeller(facet = st.labs)) + 
  labs(x="Trait anxiety", y="Density")

muu_mode <- ddply(df, c("Context","facet"), summarise, grp.mode=estimate_mode(Trait.anxiety))
muu_qtile <- ddply(df, c("Context","facet"), summarise, grp.qtile=quantile(Trait.anxiety, probs = 0.80))
p2 <- ggplot(df, aes(x=Trait.anxiety, color=Context, fill=Context)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.3, binwidth = 2) +
  geom_density(alpha=0.2) +
  geom_vline(data=muu_mode, aes(xintercept=grp.mode, color=Context), linetype="solid", size=1.2) +
  geom_vline(data=muu_qtile, aes(xintercept=grp.qtile, color=Context), linetype="dashed", size=1.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  theme_classic() + facet_wrap(~ facet, ncol=1, labeller = labeller(facet = st.labs)) + 
  labs(x="Trait anxiety", y="Density", color="Study context", fill="Study context")

grid.arrange(p1, p2, nrow=1, widths=c(3,4))
```


```{r, fig.height = 2, fig.width = 8}
ggplot(df2_cl, aes(x=Trait.anxiety, color=Context, fill=Context)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.3, binwidth = 2) +
  geom_density(alpha=0.2) +
  scale_color_brewer(palette="Dark2") +  scale_fill_brewer(palette="Dark2") +
  theme_classic() + facet_grid(facet ~ Site)
```

